#!/usr/bin/env bash

set -e

if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

source "$basedir/../bin/common.sh"
source "$basedir/../config/versions.sh"
source "$basedir/../support/lib/utils"

BUILD_DIR="$1"

mkdir -p "${BUILD_DIR}/vendor/nginx"
mkdir -p "${BUILD_DIR}/vendor/nginx/conf"
mkdir -p "${BUILD_DIR}/bin"

openresty_version="${default_openresty_version}"

tempdir=$(mktmpdir openresty)
cd $tempdir

status "Downloading OpenResty ${openresty_version}"

curl --location --remote-name --silent "https://openresty.org/download/openresty-${openresty_version}.tar.gz"
tar -xzf "openresty-${openresty_version}.tar.gz"
cd "openresty-${openresty_version}"

# HTTP_REDIS_VERSION=${default_http_redis}
# HTTP_REDIS_NGINX_DIR="ngx_http_redis-${HTTP_REDIS_VERSION}"
# HTTP_REDIS_TARBALL="ngx_http_redis-${HTTP_REDIS_VERSION}.tar.gz"
# HTTP_REDIS_URL="https://people.freebsd.org/~osa/${HTTP_REDIS_TARBALL}"

# status "Downloading http redis module ${HTTP_REDIS_VERSION}"

# curl --remote-name --location --silent "${HTTP_REDIS_URL}"
# tar -xzvf "${HTTP_REDIS_TARBALL}"


# mkdir modules

zlib_version="$default_zlib_version"

if [ -z "$NGINX_PCRE_VERSION" ]; then
  # From https://sourceforge.net/projects/pcre/files/pcre/
  NGINX_PCRE_VERSION=8.45
fi

pcre_version="$NGINX_PCRE_VERSION"

status "Downloading dependency PCRE ${pcre_version}"

curl --location --remote-name --silent "https://sourceforge.net/projects/pcre/files/pcre/${pcre_version}/pcre-${pcre_version}.tar.gz"
tar -xzf "pcre-${pcre_version}.tar.gz"

status "Downloading dependency zlib ${zlib_version}"

zlib_filename="zlib-${zlib_version}.tar.gz"
curl --location --remote-name --silent "https://github.com/madler/zlib/releases/download/v1.2.13/${zlib_filename}"
file "$zlib_filename"
tar -xzf "$zlib_filename"

status "Installing OpenResty ${openresty_version}"

./configure --prefix="${BUILD_DIR}/vendor/nginx" --with-http_ssl_module --with-http_auth_request_module --with-pcre="./pcre-${pcre_version}" --with-zlib="./zlib-${zlib_version}" --with-http_realip_module
make
make install

export PATH=/usr/local/openresty/bin:/usr/local/openresty/nginx/sbin:$PATH

# make modules

# if test -f "${tempdir}/nginx-${nginx_version}/objs/ngx_http_redis_module.so"; then
#   status "HTTP redis module compiled available at ${tempdir}/nginx-${nginx_version}/objs/ngx_http_redis_module.so"
# else
#   status "Error while creating HTTP Redis module"
# fi

# # Copy to Scalingo Nginx
# BUILD_DIR="$1"
# cp "${tempdir}/nginx-${nginx_version}/objs/ngx_http_redis_module.so" "$BUILD_DIR/vendor/nginx/modules/"

# # Update Scalingo  Nginx conf
# sed -i '1iload_module modules/ngx_http_modsecurity_module.so;' "$BUILD_DIR/vendor/nginx/conf/nginx.conf"


#######
# Prepa du terrain

test ! -d "$BUILD_DIR/.profile.d" && mkdir -p "$BUILD_DIR/.profile.d" || true

cat > "$BUILD_DIR/.profile.d/nginx.sh" <<SH
export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/app/bin:${VENDORED_NGINX}/sbin:/app/vendor/bin:\$PATH
export APP_BUILD_TIME=$(date +%Y%m%d%H%M%S)
SH

source "$BUILD_DIR/.profile.d/nginx.sh"

cp "$basedir/../config/nginx.conf.erb" "$BUILD_DIR/base_nginx.conf.erb"

cat > "${BUILD_DIR}/bin/run" <<SH
#!/usr/bin/env bash

basedir="\$( cd -P "\$(dirname \$(dirname "\$0" ))" && pwd )"
pmsgr=/tmp/pmsgr
rm -f \$pmsgr
mkfifo \$pmsgr

PATH=\$basedir/vendor/nginx/sbin:$PATH
export PATH

[ -f \$basedir/servers.conf.erb ] && export HAS_SERVER_CONF=true

erb base_nginx.conf.erb > "\$basedir/vendor/nginx/conf/nginx.conf"

if [ -f "\$basedir/nginx.conf.erb" ] ; then
  erb "\$basedir/nginx.conf.erb" > "\$basedir/vendor/nginx/conf/site.conf"
elif [ -f \$basedir/servers.conf.erb ] ; then
  erb "\$basedir/servers.conf.erb" > "\$basedir/vendor/nginx/conf/servers.conf"
elif [ -f \$basedir/nginx.conf ] ; then
  cp "\$basedir/nginx.conf" "\$basedir/vendor/nginx/conf/site.conf"
else
  echo 'nginx.conf or nginx.conf.erb should be located at the root of the project'
  exit 1
fi

(
    nginx -p "\$basedir/vendor/nginx" -c "\$basedir/vendor/nginx/conf/nginx.conf"
    echo "nginx" > \$pmsgr
) &

read exitproc <\$pmsgr
echo "Boot failed: \$exitproc"
exit 1
SH

chmod +x "${BUILD_DIR}/bin/run"