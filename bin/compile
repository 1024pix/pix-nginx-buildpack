#!/usr/bin/env bash
#
# This script is used for the [Nginx
# buildpack](github.com/Scalingo/nginx-buildpack/). Please refer to this page
# (https://www.notion.so/scalingooriginal/New-Nginx-Version-936b92e173a74f5ab0cd59e5155a4880)
# on how to use it.
#

set -e

if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

source "$basedir/../bin/common.sh"
source "$basedir/../config/versions.sh"
source "$basedir/../support/lib/utils"

nginx_version="${default_nginx_version}"

tempdir=$(mktmpdir http_redis)
cd $tempdir

curl --location --remote-name --silent "https://nginx.org/download/nginx-${nginx_version}.tar.gz"
tar -xzf "nginx-${nginx_version}.tar.gz"


cd "nginx-${nginx_version}"

HTTP_REDIS_VERSION=${default_http_redis}
HTTP_REDIS_NGINX_DIR="ngx_http_redis-${HTTP_REDIS_VERSION}"
HTTP_REDIS_TARBALL="ngx_http_redis-${HTTP_REDIS_VERSION}.tar.gz"
HTTP_REDIS_URL="https://people.freebsd.org/~osa/${HTTP_REDIS_TARBALL}"

status "Downloading http redis module ${HTTP_REDIS_VERSION}"

curl --remote-name --location --silent "${HTTP_REDIS_URL}"
tar -xzvf "${HTTP_REDIS_TARBALL}"


mkdir modules

zlib_version="$default_zlib_version"

if [ -z "$NGINX_PCRE_VERSION" ]; then
  # From https://sourceforge.net/projects/pcre/files/pcre/
  NGINX_PCRE_VERSION=8.45
fi

pcre_version="$NGINX_PCRE_VERSION"

status "Downloading dependency PCRE ${pcre_version}"

curl --location --remote-name --silent "https://sourceforge.net/projects/pcre/files/pcre/${pcre_version}/pcre-${pcre_version}.tar.gz"
tar -xzf "pcre-${pcre_version}.tar.gz"

status "Downloading dependency zlib ${zlib_version}"

zlib_filename="zlib-${zlib_version}.tar.gz"
curl --location --remote-name --silent "https://github.com/madler/zlib/releases/download/v1.2.13/${zlib_filename}"
file "$zlib_filename"
tar -xzf "$zlib_filename"

./configure --prefix=/app/vendor/nginx --with-http_ssl_module --with-http_auth_request_module --with-pcre="./pcre-${pcre_version}" --with-zlib="./zlib-${zlib_version}" --with-http_realip_module --add-dynamic-module="${tempdir}/nginx-${nginx_version}/${HTTP_REDIS_NGINX_DIR}"

make

make modules

if test -f "${tempdir}/nginx-${nginx_version}/objs/ngx_http_redis_module.so"; then
  status "HTTP redis module compiled available at ${tempdir}/nginx-${nginx_version}/objs/ngx_http_redis_module.so"
else
  status "Error while creating HTTP Redis module"
fi

# Copy to Scalingo Nginx
cp "${tempdir}/nginx-${nginx_version}/objs/ngx_http_redis_module.so" "\$basedir/vendor/nginx/modules/"

# Update Scalingo  Nginx conf
sed -i '1iload_module modules/ngx_http_modsecurity_module.so;' "\$basedir/vendor/nginx/conf/nginx.conf"
